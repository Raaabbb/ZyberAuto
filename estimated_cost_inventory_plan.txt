================================================================================
         ESTIMATED COST & INVENTORY INTEGRATION - IMPLEMENTATION PLAN
================================================================================
Date: February 4, 2026
Status: âœ… IMPLEMENTED
================================================================================

--------------------------------------------------------------------------------
FEATURE OVERVIEW
--------------------------------------------------------------------------------

When a customer selects a REPAIR TYPE during booking:
1. System automatically calculates ESTIMATED COST based on:
   - Service labor fee (based on service + vehicle type)
   - Required parts/items for that service type
   
2. System checks INVENTORY AVAILABILITY:
   - If all items available: Normal booking
   - If any item out of stock: Booking still allowed, but flagged
   
3. Secretary sees flagged bookings with "INSUFFICIENT ITEMS" warning

4. When booking is APPROVED or COMPLETED:
   - Items are automatically DEDUCTED from inventory

--------------------------------------------------------------------------------
SECTION 1: DATA MODELS
--------------------------------------------------------------------------------

1.1 NEW: InventoryItem Model
    Location: domain/model/InventoryItem.kt
    
    data class InventoryItem(
        val id: String = "",
        val name: String = "",              // "Oil Filter", "Brake Pads Set"
        val category: String = "",          // "Filters", "Brakes", "Fluids", "Tools"
        val unitPrice: Double = 0.0,        // Price per unit
        val stockQuantity: Int = 0,         // Current stock count
        val unit: String = "piece",         // "piece", "liter", "set", "pair"
        val reorderLevel: Int = 5,          // Alert when stock below this
        val lastUpdated: Long = 0
    )

1.2 NEW: ServiceParts Mapping Model
    Location: domain/model/ServiceParts.kt
    
    data class ServicePartRequirement(
        val serviceType: String,            // "Oil Change"
        val partName: String,               // "Oil Filter"
        val quantityNeeded: Double = 1.0,   // How many needed per service
        val isRequired: Boolean = true      // Required vs optional
    )

1.3 UPDATE: Appointment Model
    Location: domain/model/Appointment.kt
    
    ADD these fields:
    - estimatedLaborCost: Double = 0.0
    - estimatedPartsCost: Double = 0.0
    - estimatedTotalCost: Double = 0.0
    - hasInsufficientItems: Boolean = false  // Flag for secretary
    - insufficientItemsList: List<String> = emptyList()  // Which items are lacking
    - partsToDeduct: List<PartDeduction> = emptyList()   // Parts to deduct on approval
    
    data class PartDeduction(
        val itemId: String,
        val itemName: String,
        val quantity: Double,
        val unitPrice: Double
    )

--------------------------------------------------------------------------------
SECTION 2: CONSTANTS & PRICING
--------------------------------------------------------------------------------

2.1 UPDATE: AppConstants.kt
    
    ADD Service Base Prices (Labor Only):
    
    val ServiceBasePrices = mapOf(
        "Oil Change" to 500.0,
        "Tire Rotation" to 300.0,
        "Brake Inspection" to 400.0,
        "Full Detailing" to 1500.0,
        "Engine Tune-Up" to 2000.0,
        "AC Service" to 800.0,
        "Battery Check" to 200.0,
        "General Repair" to 1000.0
    )
    
    Note: Labor cost = ServiceBasePrices[service] Ã— VehicleTypeMultipliers[vehicleType]

2.2 NEW: Default Parts Per Service (in AppConstants or separate config)
    
    val ServiceRequiredParts = mapOf(
        "Oil Change" to listOf(
            PartRequirement("Oil Filter", 1.0),
            PartRequirement("Engine Oil", 4.0)  // 4 liters
        ),
        "Tire Rotation" to listOf(
            // No consumable parts, labor only
        ),
        "Brake Inspection" to listOf(
            PartRequirement("Brake Fluid", 0.5)  // 0.5 liters
        ),
        "Full Detailing" to listOf(
            PartRequirement("Car Shampoo", 0.5),
            PartRequirement("Wax Polish", 0.3),
            PartRequirement("Interior Cleaner", 0.3)
        ),
        "Engine Tune-Up" to listOf(
            PartRequirement("Spark Plugs Set", 1.0),
            PartRequirement("Air Filter", 1.0),
            PartRequirement("Fuel Filter", 1.0)
        ),
        "AC Service" to listOf(
            PartRequirement("AC Refrigerant", 1.0),
            PartRequirement("AC Filter", 1.0)
        ),
        "Battery Check" to listOf(
            PartRequirement("Distilled Water", 1.0)
        ),
        "General Repair" to listOf(
            // Parts determined at time of service
        )
    )

--------------------------------------------------------------------------------
SECTION 3: REPOSITORY LAYER
--------------------------------------------------------------------------------

3.1 NEW: InventoryRepository Interface
    Location: domain/repository/InventoryRepository.kt
    
    interface InventoryRepository {
        fun getAllItems(): Flow<List<InventoryItem>>
        fun getItemByName(name: String): Flow<InventoryItem?>
        fun getItemsByCategory(category: String): Flow<List<InventoryItem>>
        suspend fun addItem(item: InventoryItem): Result<String>
        suspend fun updateItem(item: InventoryItem): Result<Unit>
        suspend fun updateStock(itemId: String, newQuantity: Int): Result<Unit>
        suspend fun deductStock(itemId: String, amount: Double): Result<Unit>
        suspend fun checkAvailability(partName: String, quantityNeeded: Double): Boolean
        suspend fun batchDeductStock(deductions: List<PartDeduction>): Result<Unit>
    }

3.2 NEW: InventoryRepositoryImpl
    Location: data/repository/InventoryRepositoryImpl.kt
    
    - Uses Firestore collection: "inventory"
    - Implements all interface methods
    - batchDeductStock uses Firestore batch/transaction for atomicity

3.3 UPDATE: AppointmentsRepository
    - No changes needed (appointment already has new fields)

--------------------------------------------------------------------------------
SECTION 4: COST CALCULATION SERVICE
--------------------------------------------------------------------------------

4.1 NEW: CostEstimationService
    Location: domain/service/CostEstimationService.kt (or common/CostEstimator.kt)
    
    class CostEstimationService @Inject constructor(
        private val inventoryRepository: InventoryRepository
    ) {
        suspend fun calculateEstimate(
            serviceType: String,
            vehicleType: String
        ): CostEstimateResult {
            
            // 1. Calculate labor cost
            val baseLabor = AppConstants.ServiceBasePrices[serviceType] ?: 1000.0
            val multiplier = AppConstants.VehicleTypeMultipliers[vehicleType] ?: 1.0
            val laborCost = baseLabor * multiplier
            
            // 2. Get required parts for this service
            val requiredParts = AppConstants.ServiceRequiredParts[serviceType] ?: emptyList()
            
            // 3. Calculate parts cost & check availability
            var partsCost = 0.0
            val partsToDeduct = mutableListOf<PartDeduction>()
            val insufficientItems = mutableListOf<String>()
            
            for (partReq in requiredParts) {
                val inventoryItem = inventoryRepository.getItemByName(partReq.partName).first()
                
                if (inventoryItem != null) {
                    val subtotal = inventoryItem.unitPrice * partReq.quantityNeeded
                    partsCost += subtotal
                    
                    partsToDeduct.add(PartDeduction(
                        itemId = inventoryItem.id,
                        itemName = inventoryItem.name,
                        quantity = partReq.quantityNeeded,
                        unitPrice = inventoryItem.unitPrice
                    ))
                    
                    // Check if enough stock
                    if (inventoryItem.stockQuantity < partReq.quantityNeeded) {
                        insufficientItems.add("${partReq.partName} (need ${partReq.quantityNeeded}, have ${inventoryItem.stockQuantity})")
                    }
                } else {
                    // Item not in inventory at all
                    insufficientItems.add("${partReq.partName} (not in inventory)")
                }
            }
            
            return CostEstimateResult(
                laborCost = laborCost,
                partsCost = partsCost,
                totalEstimate = laborCost + partsCost,
                partsToDeduct = partsToDeduct,
                hasInsufficientItems = insufficientItems.isNotEmpty(),
                insufficientItems = insufficientItems
            )
        }
    }
    
    data class CostEstimateResult(
        val laborCost: Double,
        val partsCost: Double,
        val totalEstimate: Double,
        val partsToDeduct: List<PartDeduction>,
        val hasInsufficientItems: Boolean,
        val insufficientItems: List<String>
    )

--------------------------------------------------------------------------------
SECTION 5: BOOKING FLOW CHANGES
--------------------------------------------------------------------------------

5.1 UPDATE: NewBookingViewModel.kt
    
    When service type is selected:
    - Call CostEstimationService.calculateEstimate()
    - Store result in state flow for UI display
    - Include in Appointment when submitting
    
    New state flows:
    - _estimatedCost: StateFlow<CostEstimateResult?>
    - Expose: val estimatedCost: StateFlow<CostEstimateResult?>
    
    Update submitBooking():
    - Add estimatedLaborCost, estimatedPartsCost, estimatedTotalCost
    - Add hasInsufficientItems, insufficientItemsList, partsToDeduct

5.2 UPDATE: NewBookingScreen.kt
    
    After service type dropdown, show estimate card:
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ğŸ’° ESTIMATED COST                   â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ Labor:  â‚±600.00                     â”‚
    â”‚ Parts:  â‚±350.00                     â”‚
    â”‚         â”œâ”€ Oil Filter (1x â‚±150)     â”‚
    â”‚         â””â”€ Engine Oil (4L Ã— â‚±50)    â”‚
    â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
    â”‚ TOTAL ESTIMATE: â‚±950.00             â”‚
    â”‚                                     â”‚
    â”‚ âš ï¸ Note: Final price may vary       â”‚
    â”‚    based on actual service needs    â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    
    If insufficient items, show warning but allow submission:
    
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ âš ï¸ SOME ITEMS LOW IN STOCK          â”‚
    â”‚ â€¢ Oil Filter (need 1, have 0)       â”‚
    â”‚                                     â”‚
    â”‚ You can still submit. The shop will â”‚
    â”‚ contact you about availability.     â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

5.3 UPDATE: WalkInViewModel.kt & WalkInScreen.kt
    
    Same changes as NewBooking:
    - Calculate estimate when service selected
    - Show estimate and warnings
    - Store in appointment

--------------------------------------------------------------------------------
SECTION 6: SECRETARY VIEW CHANGES
--------------------------------------------------------------------------------

6.1 UPDATE: SecretaryAppointmentsScreen.kt / BookingRequestsScreen
    
    For appointments with hasInsufficientItems = true:
    - Show warning badge/icon on card
    - Different card border color (orange/yellow)
    - Show list of insufficient items
    
    Visual indicator example:
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ ğŸ”§ Oil Change          âš ï¸ PENDING  â”‚
    â”‚ Customer: John Doe                  â”‚
    â”‚ Date: Feb 10, 2026 â€¢ 11:00 AM       â”‚
    â”‚                                     â”‚
    â”‚ âš ï¸ INSUFFICIENT ITEMS:              â”‚
    â”‚ â€¢ Oil Filter (need 1, have 0)       â”‚
    â”‚                                     â”‚
    â”‚ Est. Cost: â‚±950.00                  â”‚
    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

6.2 UPDATE: BookingDetailsScreen.kt
    
    Show full cost breakdown:
    - Labor cost
    - Parts list with prices
    - Total estimate
    - Insufficient items warning (if any)

--------------------------------------------------------------------------------
SECTION 7: INVENTORY DEDUCTION ON APPROVAL/COMPLETION
--------------------------------------------------------------------------------

7.1 OPTION A: Deduct on APPROVAL
    
    When secretary accepts appointment:
    - Call inventoryRepository.batchDeductStock(appointment.partsToDeduct)
    - If deduction fails (stock changed), show error
    
    Pros: Reserves parts immediately
    Cons: What if appointment is cancelled after approval?

7.2 OPTION B: Deduct on COMPLETION (RECOMMENDED)
    
    When secretary marks as COMPLETED:
    - Call inventoryRepository.batchDeductStock(appointment.partsToDeduct)
    
    Pros: Only deducts when service actually done
    Cons: Parts might be used by another appointment in between
    
    RECOMMENDATION: Option B with re-check at completion

7.3 UPDATE: SecretaryAppointmentsViewModel or relevant ViewModel
    
    In completeAppointment() function:
    
    suspend fun completeAppointment(appointmentId: String) {
        val appointment = getAppointment(appointmentId)
        
        // 1. Deduct inventory
        if (appointment.partsToDeduct.isNotEmpty()) {
            inventoryRepository.batchDeductStock(appointment.partsToDeduct)
                .onFailure { 
                    // Log error but don't block completion
                    // Inventory might need manual adjustment
                }
        }
        
        // 2. Update status to COMPLETED
        appointmentsRepository.updateAppointmentStatus(appointmentId, "COMPLETED")
    }

--------------------------------------------------------------------------------
SECTION 8: SECRETARY INVENTORY MANAGEMENT SCREEN
--------------------------------------------------------------------------------

8.1 NEW: InventoryScreen.kt (Optional but recommended)
    
    Location: presentation/secretary/inventory/InventoryScreen.kt
    
    Features:
    - View all inventory items
    - Add new items
    - Update stock quantities
    - See low stock alerts
    - View item usage history (future)
    
    Access: Add to Secretary bottom navigation or settings

8.2 NEW: InventoryViewModel.kt
    
    Location: presentation/secretary/inventory/InventoryViewModel.kt
    
    Functions:
    - loadAllItems()
    - addItem(item)
    - updateStock(itemId, quantity)
    - searchItems(query)
    - filterByCategory(category)

--------------------------------------------------------------------------------
SECTION 9: IMPLEMENTATION ORDER
--------------------------------------------------------------------------------

PHASE 1: Data Layer (Foundation)
    1. Create InventoryItem model
    2. Create InventoryRepository interface
    3. Create InventoryRepositoryImpl (Firestore)
    4. Add DI bindings in RepositoryModule

PHASE 2: Constants & Mapping
    5. Add ServiceBasePrices to AppConstants
    6. Add ServiceRequiredParts mapping to AppConstants
    7. Update Appointment model with cost fields

PHASE 3: Cost Calculation
    8. Create CostEstimationService
    9. Inject into NewBookingViewModel
    10. Calculate estimate when service type changes

PHASE 4: Customer UI
    11. Update NewBookingScreen to show estimate card
    12. Show insufficient items warning
    13. Include cost data in booking submission

PHASE 5: Secretary UI
    14. Update appointment cards to show cost estimate
    15. Add insufficient items warning badge
    16. Update BookingDetailsScreen with cost breakdown

PHASE 6: Inventory Deduction
    17. Update complete appointment flow
    18. Add batch deduction call
    19. Handle deduction errors gracefully

PHASE 7: Inventory Management (Optional)
    20. Create InventoryScreen for secretary
    21. Add to navigation
    22. Implement CRUD operations

--------------------------------------------------------------------------------
SECTION 10: FIREBASE STRUCTURE
--------------------------------------------------------------------------------

Firestore Collection: "inventory"

Document structure:
{
    "id": "auto-generated",
    "name": "Oil Filter",
    "category": "Filters",
    "unitPrice": 150.00,
    "stockQuantity": 25,
    "unit": "piece",
    "reorderLevel": 5,
    "lastUpdated": 1738656000000
}

Sample documents to seed:
- Oil Filter (Filters) - â‚±150/piece - Stock: 20
- Engine Oil (Fluids) - â‚±50/liter - Stock: 100
- Brake Fluid (Fluids) - â‚±80/liter - Stock: 30
- Brake Pads Set (Brakes) - â‚±500/set - Stock: 10
- Spark Plugs Set (Engine) - â‚±300/set - Stock: 15
- Air Filter (Filters) - â‚±200/piece - Stock: 12
- Fuel Filter (Filters) - â‚±180/piece - Stock: 10
- AC Refrigerant (AC) - â‚±400/can - Stock: 8
- AC Filter (AC) - â‚±250/piece - Stock: 10
- Car Shampoo (Detailing) - â‚±100/liter - Stock: 20
- Wax Polish (Detailing) - â‚±150/liter - Stock: 15
- Interior Cleaner (Detailing) - â‚±120/liter - Stock: 15
- Distilled Water (Fluids) - â‚±30/liter - Stock: 50

--------------------------------------------------------------------------------
SECTION 11: EDGE CASES TO HANDLE
--------------------------------------------------------------------------------

11.1 Item not in inventory database
    - Treat as insufficient
    - Show in warning list
    
11.2 Stock becomes insufficient between booking and completion
    - Re-check at completion
    - Allow completion but log discrepancy
    - Secretary can manually adjust inventory
    
11.3 "General Repair" service type
    - No default parts
    - Labor cost only
    - Secretary adds parts manually (future enhancement)
    
11.4 Price changes after booking
    - Keep original estimate in appointment
    - Final price uses estimate (locked at booking time)
    
11.5 Cancelled/Declined appointments
    - No inventory deduction needed
    - Just update status

--------------------------------------------------------------------------------
SECTION 12: FUTURE ENHANCEMENTS (OUT OF SCOPE)
--------------------------------------------------------------------------------

- Secretary can add/remove parts during acceptance
- Final price adjustment at completion
- Inventory restock alerts/notifications
- Purchase order generation when low stock
- Item usage history/reports
- Supplier management
- Barcode scanning for inventory

================================================================================
                              END OF PLAN
================================================================================
